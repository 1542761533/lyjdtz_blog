---
import { Icon } from "astro-icon/components";
import WidgetLayout from "./WidgetLayout.astro";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";

interface Props {
  class?: string;
  style?: string;
}

const className = Astro.props.class;
const style = Astro.props.style;
---

<WidgetLayout 
  name="当前位置" 
  id="location-widget" 
  class={className} 
  style={style}
>
  <div id="location-content" class="text-center p-2">
    <div class="flex justify-center items-center gap-2 mb-2">
      <Icon name="ic:baseline-location-on" class="text-[var(--primary)] animate-pulse" />
      <span id="location-status" class="text-sm text-neutral-400">正在获取位置...</span>
    </div>
    <div id="location-info" class="hidden">
      <div id="location-greeting" class="font-medium text-neutral-200 dark:text-neutral-800"></div>
    </div>
    <div id="location-error" class="hidden text-sm text-red-400"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const statusElement = document.getElementById('location-status');
      const infoElement = document.getElementById('location-info');
      const errorElement = document.getElementById('location-error');

      try {
        // 使用ipapi.co API获取地理位置信息
        const response = await fetch('https://ipapi.co/json/');
        if (!response.ok) {
          throw new Error('获取位置信息失败');
        }
        
        const data = await response.json();
        
        // 显示位置信息
        statusElement.classList.add('hidden');
        infoElement.classList.remove('hidden');
        
        // 构建位置信息字符串
        const locationParts = [];
        
        // 添加城市
        if (data.city) {
          locationParts.push(data.city);
        }
        
        // 如果没有获取到完整信息，则使用默认值
        if (locationParts.length === 0) {
          throw new Error('无法解析位置信息');
        }
        
        // 构建问候语
        const greetingElement = document.getElementById('location-greeting');
        greetingElement.textContent = `来自 ${locationParts.join(' ')} 的小伙伴，你好啊`;
      } catch (error) {
        statusElement.classList.add('hidden');
        errorElement.classList.remove('hidden');
        errorElement.textContent = error.message || '获取位置信息失败';
      }
    });
  </script>
</WidgetLayout>